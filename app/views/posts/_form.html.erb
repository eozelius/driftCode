<% if @post.errors.any? %>
  <div class="errors">
    <p class="title">whoops</p>
    <ul class="errors-list">
      <% @post.errors.full_messages.each do |msg| %>
        <li><p><%= msg %></p></li>
      <% end %>
    </ul>
  </div>  
<% end %>

<div id="edit-driftmap-container">
  <button class="toggle-wizard normal"><i class="fa fa-reorder"></i></button>

  <div class="wizard-container">
    <ul class="tabs-menu">
      <li data-step="title" class="wizard-table">title</li>
      <li data-step="body" class="wizard-table" style="font-size:.88em;line-height: 26px;">descrip- tion</li>
      <li data-step="routes" class="active-tab wizard-table" style="font-size:.88em;">journeys</li>
      <li data-step="markers" class="wizard-table"></i>blips</li>
    </ul>

    <div class="driftmap-form-container">
      <%= form_for @post, html: { multipart: true } do |f| %>
        <%= f.hidden_field :init_x %>
        <%= f.hidden_field :init_y %>
        <%= f.hidden_field :init_zoom %>

        <!-- Step 1 Title -->
        <div class="title-container wizard-step hidden">
          <div class="wizard-title">
            <p class="instructions-title">driftMap title</p>
            <%= f.text_field :title %>
            <p class="instructions-title" style="margin-top:15px;">you can also adjust the default location and zoom of your driftMap</p>
            <span class="normal update-zoom">set location</span>
          </div>
        </div>

        <!-- Step 2 description -->
        <div class="body-container wizard-step hidden">
          <div class="wizard-body" >
            <p class="instructions-title">driftMap description</p>
            <div class="action-body">
              <%= f.text_area :body, id: 'driftmap-body' %>
            </div>
          </div>
        </div>

        <!-- Step 4 routes -->
        <div class="routes-container wizard-step">
          <div class="wizard-routes">
            <a class="reveal-route-info">readme</a>
            <p class="instructions-title hidden">you can organize your map into journeys, tracking your progress around the globe, and associating a set of blips with a specific journey</p>
            <!-- <textarea id="route_0_description" class="route-description" name="route[0][description]"></textarea> -->
            
            <ul>
              <% @post.routes.each do |route| %>
                <li><%= route.title %></li>
              <% end %>
            </ul>
          </div>
        </div>
        
        <!-- Step 3 blips -->
        <div class="markers-container wizard-step hidden">
          <div class="wizard-markers">
            <span class="normal create-blip">create blip</span>
            <p class="instructions-title">a blip is a moment in time on your map.  It can be a park, a tour, cafe, experience or anything you would like it to be.  you may give your radar blip(s) names, descriptions and image galleries.</p>
          </div>
        </div>

        <span class="save-wizard normal">save driftMap</span>

      <% end %>
    </div>
  </div>

  <!-- driftmap -->
  <div id="map"></div>

  <%= render 'driftmap/init_driftmap' %>

  <span class="save-zoom normal hidden">save default view</span>
  <span class="save-wizard normal bottom">save driftMap</span>

  <script type="text/javascript">
    var blipIndex = -1;
    var routeIndex = -1;
    var routePointIndex = -1;
    var routePoints = [];
    
    // Add route to map
    $('.create-route').on('click', function(){
      routeIndex++;
      window.map.off('click').on('click', function(e){
        var lat = e.latlng.lat.toFixed(7);
        var lng = e.latlng.lng.toFixed(7);
        var newPoint = L.latLng(lat, lng)
        routePoints.push(newPoint);

        add_route(window.map, routeIndex, ++routePointIndex, routePoints);
      });
    });

    // Add blip to map
    $('.create-blip').on('click', function(){
      window.map.off('click').on('click', function(e){
        add_blip(window.map, e, ++blipIndex);
      });
    });

    // toggle wizard
    $('.toggle-wizard').on('click', function(){
      $('.wizard-container').toggleClass('hidden');
    });

    // Change menu tab
    $('.tabs-menu li').on('click', function(){
      $('.active-tab').removeClass('active-tab');
      var tab = $(this).data('step');
      $(this).addClass('active-tab');

      $('.wizard-step').addClass('hidden');
      $('.'+ tab + '-container').removeClass('hidden');    
    });

    // Submit form
    $('.save-wizard').on('click', function(){
      $('.driftmap-form-container form').submit();
    });

    // user wants to update location
    $('.update-zoom').on('click', function(){
      $('.wizard-container, .save-zoom').toggleClass('hidden');
    });

    // save location/zoom
    $('.save-zoom').on('click', function(){
      $('.wizard-container, .save-zoom').toggleClass('hidden');
      alert('location and zoom saved.')
      var init_x = window.map.getCenter().lat;
      var init_y = window.map.getCenter().lng;
      var zoom   = window.map.getZoom();
    
      // Post/DriftMap attrs
      $('#post_init_x').val(init_x);
      $('#post_init_y').val(init_y);
      $('#post_init_zoom').val(zoom);
    });

    $('.reveal-route-info').on('click', function(){
      $('.routes-container p').toggleClass('hidden');
    });

    // Cannot upload images larger than 3M
    $('#post_picture').on('change', function() {
      var size_in_megabytes = this.files[0].size/1024/1024;
      if (size_in_megabytes > 3){
        alert('Maximum file size is 3MB. Please choose a smaller file.');
        return false;
      }
    });
  </script>
</div>