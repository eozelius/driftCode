<div class="container">
	<!-- Blip title images body -->
	<div id="dm-content-container" class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
		<div class="blip-content" data-blip="<%= @blip.id %>">
			<%= form_for @blip, html: { multipart: true } do |f| %>
				<%= f.hidden_field :x, value: @blip.x %>
				<%= f.hidden_field :y, value: @blip.y %>

				<% if @blip.blip_images.any? %>
					<!-- carousel -->
					<div class="form-blip-images">
						<div id="images-carousel" class="carousel slide" data-ride="carousel">
							<div class="carousel-inner" role="listbox">
							  <% @blip.blip_images.each_with_index do |image, i| %>
							    <div class="item <%= 'active' if i == 0 %>">
							      <%= image_tag image.image %>
							    </div>
							  <% end %>

							  <% if @blip.blip_images.count > 1 %>
						    	<!-- Indicators -->
						    	<ol class="carousel-indicators">
						    	  <% @blip.blip_images.count.times do |b| %>
						    	    <li data-target="#images-carousel" data-slide-to="<%= b %>" class="active"></li>
						    	  <% end %>
						    	</ol>

							    <!-- Controls -->
							    <a class="left carousel-control" href="#images-carousel" role="button" data-slide="prev">
							      <i class="fa fa-angle-left fa-3x" aria-hidden="true"></i>
							      <span class="sr-only">Previous</span>
							    </a>
							    <a class="right carousel-control" href="#images-carousel" role="button" data-slide="next">
							      <i class="fa fa-angle-right fa-3x" aria-hidden="true"></i>
							      <span class="sr-only">Next</span>
							    </a>
						    <% end %>
							</div>
						</div>
					</div>
				<% end %>

				<!-- photos -->
				<h4 class="blip-title" data-photo-index="0">add photos</h4>

				<span class="normal add-photo" style="margin: 0 0 35px 3%;"><i class="fa fa-plus"></i> photo</span>

				<!-- title -->
				<h4 class="blip-title">Title</h4>
				<%= f.text_field :title %>

				<!-- body -->
				<h4 class="blip-title">Description</h4>
				<%= f.text_area :body %>

				<!-- date -->
				<div class='input-group date' id='datetimepicker1'>
					<h4 class="blip-title" style="margin:10% 0 8% 8%">Date</h4>
					<input id="blip-date" style="margin: 0% 0 8% 8%; font-size:18px; width:80%; height:38px; padding:4px;" type='text' class="form-control" />
					<%= f.hidden_field :date %>
					<span class="input-group-addon" style="float:left; margin-top:0%; height:38px; padding:10px 0 0 1px; width:30px">
						<span class="glyphicon glyphicon-calendar"></span>
					</span>
				</div>
			<% end %>
		</div>
	</div>

	<div id="dm-legend" class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
		<div class="map-container">

			<h4 class="blip-title">
				click and drag the marker to adjust the blip location
			</h4>

			<div id='map'></div>

			<button name="commit" class="normal commit" type="submit" style="margin: 35px 0">save</button>

			<%= link_to user_path(current_user) do %>
				<span class="normal cancel">cancel</span>
			<% end %>

			<%= link_to @blip, method: :delete, data: { confirm: "Are you Sure?" } do %>
				<span class="pull-right" style="margin: 14% 0 0; color:red" rel="nofollow" data-method="delete" data-confirm="Are you sure">delete</span>
			<% end %>

			<script type="text/javascript">
				var blips = [];
				var blipImages = [];

				<% @blip.blip_images.each do |blip_image| %>
					blipImages.push('<%= image_tag(blip_image.image).html_safe %>');
				<% end %>

				var driftmap = {
					init_x: '<%= @blip.x %>',
					init_y: '<%= @blip.y %>',
					init_zoom: 10,
				}

				blips.push({
					id: 		"<%= @blip.id %>",
					x: 			"<%= @blip.x %>",
					y: 			"<%= @blip.y %>",
					title: 	"<%= @blip.title.to_json %>",
					body: 	"<%= @blip.body.to_json %>",
					images: blipImages
				});

				init_map('map', driftmap, blips);
			</script>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function(){
		// init date-picker-calender
		$('#datetimepicker1').datetimepicker();

		// add photos
		var photo_index = 0;
		$(document).on('click', '.add-photo', function(){
			$(this).data('photo-index', ++photo_index)
			var index = $(this).data('photo-index')
			var new_img = '<input class="blip-image" name="photo['+ index +']" accept="image/jpeg, image/gif, image/png, image/jpg" type="file" data-image="'+ index +'" style="margin: 6% 6% 5% 3%; width:100%;">';
			$('.add-photo').last().after(new_img);
		});

		// enable dragging for the marker
		var b = window.blipMarker;
		b.dragging.enable();
		b.on('dragend', function(e){
			setLatLng(e.target.getLatLng().lat, e.target.getLatLng().lng);
		});

		// save edit
		$('.commit').on('click', function(){
			var date = $('#blip_date').val();
			var mm = 	 date.slice(0, 2)
			var dd = 	 date.slice(3, 5)
			var yyyy = date.slice(6, 10);
			$('#blip_date').val(yyyy + mm + dd);
			$('form').submit();
		});

		function setLatLng(lat, lng) {
			$('#blip_x').val(lat);
			$('#blip_y').val(lng);			
		}
	});
</script>

<style type="text/css">
	.map-container {
		top: 0;
	}
</style>