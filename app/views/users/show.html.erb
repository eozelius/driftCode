<% provide(:title, @user.name) %>
<div class="container" id="profile">
	<div id="dm-content-container" class="col-lg-7 col-md-7 col-sm-7 col-xs-12">

		<!-- Routes -->
		<% if !@route.nil? %>
			<div class="route-content">
				<div id='dm-timeline' style="width: 100%; height: 600px"></div>
			</div>
		<!-- Blips -->
		<% elsif !@blips.nil? %>
			<% @blips.each_with_index do |blip, index| %>
				<div class="blip-content <%= 'hidden' if index != 0 %>" data-blip="<%= blip.id %>">
					<!-- blip carousel -->
					<% if blip.blip_images.any? %>
					  <div id="images-carousel" class="carousel slide" data-ride="carousel">
					    <!-- Blip Photos -->
					    <div class="carousel-inner" role="listbox">
					      <% blip.blip_images.each_with_index do |image, i| %>
					        <div class="item <%= 'active' if i == 0 %>">
					          <%= image_tag image.image %>
					        </div>
					      <% end %>
					    </div>

					    <% if blip.blip_images.count > 1 %>
					    	<!-- Indicators -->
					    	<ol class="carousel-indicators">
					    	  <% blip.blip_images.count.times do |b| %>
					    	    <li data-target="#images-carousel" data-slide-to="<%= b %>"></li>
					    	  <% end %>
					    	  <script type="text/javascript">
					    	    $('li[data-target="#images-carousel"]').first().addClass('active')
					    	  </script>
					    	</ol>

						    <!-- Controls -->
						    <a class="left carousel-control" href="#images-carousel" role="button" data-slide="prev">
						      <i class="fa fa-angle-left fa-3x" aria-hidden="true"></i>
						      <span class="sr-only">Previous</span>
						    </a>
						    <a class="right carousel-control" href="#images-carousel" role="button" data-slide="next">
						      <i class="fa fa-angle-right fa-3x" aria-hidden="true"></i>
						      <span class="sr-only">Next</span>
						    </a>
						  <% end %>
					  </div><!-- end carousel -->
					<% end %>

					<!-- blip title text  -->
					<div class="blip-info" data-blip="<%= blip.id %>">
					  <h4 class="blip-title">
					    <%= blip.title %>
					    <% if user_is_home(@user) %>
								<%= link_to '<span style="font-style:italic;font-size:.7em;"> - edit</span>'.html_safe, edit_blip_path(blip) %>
							<% end %>
					  </h4>

					  <p class="blip-body">
					    <%= blip.body %>
					  </p>
					</div>
				</div>
			<% end %>
		<% else %>
			<div class="start-new">
				<%= image_tag 'switzerland10.JPG' %>

				<% if user_is_home(@user) %>
					<div class="start-text">
						<%= link_to new_route_path do %>
							<p>begin an new adventure now</p>
						<% end %>
					</div>
				<% else %>
					<div class="start-text">
						<p>
							<%= @user.name %> has not added any content yet.
						</p>
					</div>
				<% end %>
			</div>
		<% end %>
	</div>

	<div id="dm-legend" class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
		<div class="map-container">
			<div id='map'></div>

			<script type="text/javascript">
				var driftmap = {
					init_x: '<%= @post.init_x %>',
					init_y: '<%= @post.init_y %>',
					init_zoom: '<%= @post.init_zoom %>',
				}

				var blips = [];

				<% if @user.post.blips.any? %>
					<% @blips.each do |blip| %>
						var blipImages = [];
						<% blip.blip_images.each do |blip_image| %>
							blipImages.push('<%= image_tag(blip_image.image).html_safe %>');
						<% end %>

						blips.push({
							id: 	"<%= blip.id %>",
							x: 		"<%= blip.x %>",
							y: 		"<%= blip.y %>",
							title: 	"<%= blip.title.to_json %>",
							body: 	"<%= blip.body.to_json %>",
							images: blipImages
						})

					<% end %>
				<% end %>

				//init_map('map', driftmap, blips, routes)
				init_map('map', driftmap, blips)
			</script>

		</div>

		<div class="view-wizard-container">
			<!-- Routes -->
			<div class="markers-container wizard-step">
		    <div class="wizard-markers">
		    	<% if @user.post.routes.count > 0 %>
		    		<ul>
		    			<li class="blip">
		    				<p class="blip-title">Journeys</p>
		    			</li>
		    			<% @user.post.routes.each do |route| %>
		    				<li class="blip" data-route="<%= route.id %>">
		    					<p class="blip-title">
		    						<%= route.title %>
		    						<% if user_is_home(@user) %>
			              	<%= link_to '<span style="font-style:italic;"> - edit</span>'.html_safe, edit_route_path(route) %>
			              <% end %>
		    					</p>
		    				</li>
		    			<% end %>
		    		</ul>
		    	<% end %>
		    </div>
		  </div>

		  <!-- blips -->
		  <div class="markers-container wizard-step">
		    <div class="wizard-markers">
		    	<% if @user.post.blips.count > 0 %>
			      <ul>
							<li class="blip">
								<p class="blip-title">Blips</p>
							</li>
			        <% @user.post.blips.each do |blip| %>
			          <li class="blip" data-blip="<%= blip.id %>" data-initx="<%= blip.x %>" data-inity="<%= blip.y %>">
			            <p class="blip-title">
			              <%= blip.title %>
			              <% if user_is_home(@user) %>
			              	<%= link_to '<span style="font-style:italic;"> - edit</span>'.html_safe, edit_blip_path(blip) %>
			              <% end %>
			            </p>
			          </li>
			        <% end %>
			      </ul>
			    <% else %>
			    	<ul>
			    		<% if user_is_home(@user) %>
								<li class="blip">
									<%= link_to new_blip_path do %>
										<p class="blip-title">
											create new blip
										</p>
									<% end %>
								</li>
							<% end %>
			    	</ul>
			    <% end %>
		    </div>
		  </div>

		  <% if user_is_home(@user) %>
		  	<p class="edit-delete-map">
		  		<%= link_to 'new journey', new_route_path %><span style="
		  		color:#23527c; font-size:14px;"> | </span> 
		  		<%= link_to 'new blip', new_blip_path %>
		  	</p>
		  <% end %>
		</div>
	</div>
</div>

<hr style="width:84%; height: 3px;background-color: #ccc; margin: 0 auto 50px;">

<div class="container">
	<div class="map-details col-lg-8 col-md-8 col-sm-12 col-xs-12">
		<h3 class="page-title post-title"><%= @post.title %><%= link_to '<span style="font-size: .48em; font-style:italic"> - edit driftmap</span>'.html_safe, edit_post_path(@post) if user_is_home(@user) %></h3>

		<p class="post-title"><%= @post.body %></p>
	</div>

	<div id="pro-parts-container" class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
		<div class="pro-part profile">
			<div class="profile-details-container">
				<div class="profile-details">
					<p><%= @user.name %></p>
					<%= image_tag @user.profile_pic, class: 'pp' if @user.profile_pic %>
					<div class="user-info">
						
						<% if @user.from %>
							<p class="user-from">from: </p>
							<p><%= @user.from %></p>
						<% end %>			

						<% if @user.gps %>
							<p class="user-gps">current location: </p>
							<p><%= @user.gps %></p>
						<% end %>
						
						<% if user_is_home(@user) || admin_user %>
							<p><%= @user.email %></p>
							<p><a class="edit-user-anchor">edit my info</a></p>
						<% end %>
					</div><div class="clear-fix"></div>

					<% if user_is_home(@user) || admin_user %>
						<div class="alter-user-container" style="display:none;">
							<%= form_for @user, html: { multipart: true } do |f| %>
								<p>
									<%= f.label 'profile picture' %>
									<%= f.file_field :profile_pic, accept: 'image/jpeg, image/gif, image/png, image/jpg' %>
								</p>
								<p>
									<%= f.label :name %>
									<%= f.text_field :name %>
								</p>

								<p>
									<%= f.label :email %>
									<%= f.text_field :email %>
								</p>							

								<p>
									<%= f.label :from, 'Where are you from?' %>
									<%= f.text_field :from %>
								</p>

								<p>
									<%= f.label :gps, 'Where are you currently?' %>
									<%= f.text_field :gps %>
								</p>

								<p>
									<%= f.label :password %>
									<%= f.password_field :password %>
								</p>

								<p>
									<%= f.label :password_confirmation %>
									<%= f.password_field :password_confirmation %>
								</p>
							
								<p>
									<button type="submit" name="commit" value="Create Post" class="normal" style="float:right">done</button>
									<span class="cancel-edit-user normal" style="float:right">cancel</span>
								</p>
							<% end %>
						</div>
					<% end %>
				</div>
			</div><!-- end profile info -->
		</div>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function(){
		// edit post
		$('a.edit-anchor').bind('click', function(){
			$('.alter-post-container').slideDown();
		});

		// cancel edit post
		$('.cancel-edit-post').on('click', function(){
			$('.alter-post-container').slideUp();
		});

		// edit profile info
		$('.edit-user-anchor').on('click', function(){
			$('.alter-user-container').slideDown();
			$('.profile-details-container').addClass('form-open');
		});

		// cancel edit user
		$('.cancel-edit-user').on('click', function(){
			$('.alter-user-container').slideUp();
			$('.profile-details-container').removeClass('form-open');
		});

		maroonMarker = L.icon({ 
		  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-maroon-icon.png").to_s %>',
		  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
		  popupAnchor:  [0, -35]
		});

		blueMarker = L.icon({
		  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-icon.png").to_s %>',
		  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
		  popupAnchor:  [0, -35]
		})

	  // reveal blip info
	  $('.blip').on('click', function(){
	    var active = $(this).hasClass('active');
	    var blip_index = $(this).data('blip');
	    $('.blip-content').addClass('hidden');
	    $('.blip-content[data-blip="'+ blip_index +'"]').removeClass("hidden");

	    for(var i in window.blipsIndexer)
	      window.blipsIndexer[i].marker.setIcon(blueMarker);

	    window.blipsIndexer[blip_index].marker.setIcon(maroonMarker);
	    window.blipsIndexer[blip_index].popup.openOn(window.map)
	    
	    if(active){
	      $(this).removeClass('active');
	    } else {
	      $('.blip-info[data-blip="'+ blip_index +'"]').slideDown(700);
	      $(this).addClass('active');
	      var init_x = $(this).data('initx') + .36377;
	      var init_y = $(this).data('inity') + .1;
	      window.map.setView([init_x, init_y]).setZoom(9);
	    }
	  });

	  /* TIMELINE */
		<% if @route.coverphoto.present? %>
			var blip_cover_image = '<%= image_path(@route.coverphoto).html_safe %>';
		<% else %>
			var blip_cover_image = '<%= image_path(switzerland10.JPG).html_safe %>';
		<% end %>

		var events = [];

		window.routesIndexer = {};

		<% @route.blips.each do |blip| %>
			events.push({
				"media": {
					url: '',
					caption: ''
				},
				start_date: {
					month: '<%= blip.date.month %>',
					day: '<%= blip.date.day %>',
					year: '<%= blip.date.year %>'
				},
				text: {
					headline: "<%= blip.title %>",
					text: "<%= blip.body %>"
				}
			});

			var routeBlipImages = [];

			<% blip.blip_images.each do |image| %>
				routeBlipImages.push('<%= image_tag(image.image).html_safe %>')
			<% end %>

			window.routesIndexer["<%= blip.id %>"] = {
				id:    "<%= blip.id %>",
				title: "<%= blip.title %>",
				body:  "<%= blip.body %>",
				date:  "<%= blip.date %>",
				images: routeBlipImages
			}
		<% end %>

		var tlJson = {
		  title: {
		    media: {
		      url: blip_cover_image,
		      caption: "<%= @route.title %>"
		    },
		    text: {
		      headline: "<%= @route.title %>",
		      text: "<%= @route.description %>"
		    }
		  },
		  events: events
		}

		var dmOptions = { timenav_height: 180 }
	  timeline = new TL.Timeline('dm-timeline', tlJson, dmOptions);

		// timeline Event listeners
		timeline.on("change", function(data) {
			window.ethan = data;
			var unique_id = data.unique_id;
			var targetBlipId = $('#' + unique_id + '-marker').attr('data-tlBlipIndex');
			var tlBlip = window.blipsIndexer[targetBlipId];

			for(var i in window.blipsIndexer)
	      window.blipsIndexer[i].marker.setIcon(blueMarker);

			tlBlip.popup.openOn(window.map);
			tlBlip.marker.setIcon(maroonMarker);
			$('.carousel').addClass('hidden');

			setTimeout(function(){
				$('.tl-slide[data-tlBlipIndex="'+ targetBlipId +'"] .carousel').removeClass('hidden');
			}, 600)
		});

		var blipIds = [];
		for(var x in window.routesIndexer)
			blipIds.push(window.blipsIndexer[x].id)

		$('.tl-timemarker').each(function(i, elem){
			$(this).attr('data-tlBlipIndex', blipIds[i])
		});

		$('.tl-slide.tl-slide-text-only').each(function(i, elem){
			$(this).attr('data-tlBlipIndex', blipIds[i])
		});

		for(var i in window.routesIndexer){
			var id = window.routesIndexer[i].id;
			console.log("id: " + id)

			if(window.routesIndexer[i].images.length > 0){
				var c = '<div id="images-carousel-'+ i +'" class="hidden carousel slide" data-ride="carousel">' + 
				  				'<div class="carousel-inner" role="listbox">';

				for(var x in window.routesIndexer[i].images){
					c += '<div class="item">' + window.routesIndexer[i].images[x] + '</div>';
				}

				if(window.routesIndexer[i].images.length > 1){
					c += '<ol class="carousel-indicators">';

					for(var i in window.routesIndexer[i].images.length){
						c +=  '<li data-target="#images-carousel-'+ i +'" data-slide-to="'+ i +'"></li>';
					}

					c +=  '</ol><a class="left carousel-control" href="#images-carousel-'+ i +'" role="button" data-slide="prev">' +
							    '<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>' +
		      			  '<span class="sr-only">Previous</span>' +
		      			'</a>' +
		      			'<a class="right carousel-control" href="#images-carousel-'+ i +'" role="button" data-slide="next">' +
		      			  '<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>' +
	    						'<span class="sr-only">Next</span>' +
		      			'</a>';
				}
				c += '</div></div>'
			}

			$('.tl-slide[data-tlBlipIndex="'+ id +'"]').addClass('emptying').empty();
			$('.tl-slide[data-tlBlipIndex="'+ id +'"]').html(c);
			$('.carousel .item:first-child').addClass('active')
		}
	});
</script>