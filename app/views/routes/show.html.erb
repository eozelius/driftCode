<div id="route" class="route-show">
	<div class="container">
		<div id="dm-content-container" class="col-lg-7 col-md-7 col-sm-7 col-xs-12">
			<div class="route-content">
				<div id='dm-timeline' style="width: 100%; height: 600px"></div>
				
			</div>
		</div>

		<div id="dm-legend" class="col-lg-5 col-md-5 col-sm-5 col-xs-12">
			<div class="map-container">
				<div id='map'></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	/* TimelineJS */
	<% if @route.coverphoto.present? %>
		var blip_cover_image = '<%= image_path(@route.coverphoto).html_safe %>';
	<% else %>
		var blip_cover_image = '<%= image_path(switzerland10.JPG).html_safe %>';
	<% end %>

	var events = [];
	<% @route.blips.each do |blip| %>
		events.push({
			"media": {
				url: '',
				caption: ''
			},
			start_date: {
				month: '<%= blip.date.month %>',
				day: '<%= blip.date.day %>',
				year: '<%= blip.date.year %>'
			},
			text: {
				headline: "<%= blip.title %>",
				text: "<%= blip.body %>"
			}
		});
	<% end %>

	var tlJson = {
	  title: {
	    media: {
	      url: blip_cover_image,
	      caption: "<%= @route.title %>"
	    },
	    text: {
	      headline: "<%= @route.title %>",
	      text: "<%= @route.description %>"
	    }
	  },
	  events: events
	}

	var dmOptions = { timenav_height: 180 }

	/* Leaflet */
	var driftmap = {
		init_x: '<%= @post.init_x %>',
		init_y: '<%= @post.init_y %>',
		init_zoom: '<%= @post.init_zoom %>',
	}

	var blips = [];

	<% @blips.each do |blip| %>
		var blipImages = [];
		<% blip.blip_images.each do |blip_image| %>
			blipImages.push('<%= image_tag(blip_image.image).html_safe %>');
		<% end %>

		blips.push({
			id: 	"<%= blip.id %>",
			x: 		"<%= blip.x %>",
			y: 		"<%= blip.y %>",
			title: 	"<%= blip.title.to_json %>",
			body: 	"<%= blip.body.to_json %>",
			images: blipImages
		})

	<% end %>

	//init_map('map', driftmap, blips, routes)
	init_map('map', driftmap, blips);
	var timeline = new TL.Timeline('dm-timeline', tlJson, dmOptions);

	var maroonMarker = L.icon({ 
	  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-maroon-icon.png").to_s %>',
	  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
	  popupAnchor:  [0, -35]
	});

	var blueMarker = L.icon({
	  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-icon.png").to_s %>',
	  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
	  popupAnchor:  [0, -35]
	});

	// timeline Event listeners
	timeline.on("change", function(data) {
		var unique_id = data.unique_id;
		var targetBlipId = $('#' + unique_id + '-marker').attr('data-tlBlipIndex');
		var tlBlip = window.blipsIndexer[targetBlipId];


		for(var i in window.blipsIndexer)
      window.blipsIndexer[i].marker.setIcon(blueMarker);

		tlBlip.popup.openOn(window.map);
		tlBlip.marker.setIcon(maroonMarker);
		$('.carousel').addClass('hidden');

		setTimeout(function(){
			$('.tl-slide[data-tlBlipIndex="'+ targetBlipId +'"] .carousel').removeClass('hidden');
		}, 500)
	});

	// add a class of tl-blip-index-X to the TL items so that I can select/focus/manipulate them as necessary
	var blipIds = [];
	for(var x in window.blipsIndexer)
		blipIds.push(window.blipsIndexer[x].id)

	$('.tl-timemarker').each(function(i, elem){
		$(this).attr('data-tlBlipIndex', blipIds[i])
	});

	$('.tl-slide.tl-slide-text-only').each(function(i, elem){
		$(this).attr('data-tlBlipIndex', blipIds[i])
	});

	for(var i in window.blipsIndexer){
		var id = window.blipsIndexer[i].id;

		if(window.blipsIndexer[i].images.length > 0){
			var c = '<div id="images-carousel-'+ i +'" class="hidden carousel slide" data-ride="carousel">' + 
			  				'<div class="carousel-inner" role="listbox">';

			for(var x in window.blipsIndexer[i].images){
				c += '<div class="item">' + window.blipsIndexer[i].images[x] + '</div>';
			}

			if(window.blipsIndexer[i].images.length > 1){
				c += '<ol class="carousel-indicators">';

				for(var i in window.blipsIndexer[i].images.length){
					c +=  '<li data-target="#images-carousel-'+ i +'" data-slide-to="'+ i +'"></li>';
				}

				c +=  '</ol><a class="left carousel-control" href="#images-carousel-'+ i +'" role="button" data-slide="prev">' +
						    '<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>' +
	      			  '<span class="sr-only">Previous</span>' +
	      			'</a>' +
	      			'<a class="right carousel-control" href="#images-carousel-'+ i +'" role="button" data-slide="next">' +
	      			  '<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>' +
    						'<span class="sr-only">Next</span>' +
	      			'</a>';
			}
			c += '</div></div>'
		}

		$('.tl-slide[data-tlBlipIndex="'+ id +'"]').empty();
		$('.tl-slide[data-tlBlipIndex="'+ id +'"]').html(c);
		$('.carousel .item:first-child').addClass('active')
	}
</script>
