<% if @post.errors.any? %>
  <div class="errors">
    <p class="title">whoops</p>
    <ul class="errors-list">
      <% @post.errors.full_messages.each do |msg| %>
        <li><p><%= msg %></p></li>
      <% end %>
    </ul>
  </div>  
<% end %>

<div class="container">
  <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
    <%= form_for @post, html: { multipart: true } do |f| %>
      <%= f.hidden_field :init_x %>
      <%= f.hidden_field :init_y %>
      <%= f.hidden_field :init_zoom %>
      <%= f.hidden_field :post_id, value: @post.id %>

      <!-- title -->
      <h4 class="waypoint-title" style="margin-top:-4px; width: 15%">Title</h4>
      <%= f.text_field :title %>

      <!-- driftmap description -->
      <h4 class="waypoint-title" style="display:inline; float:left;margin-top:0">Description</h4>

      <%= f.text_area :body %>

      <h4 class="waypoint-title" style="display:inline; float:left;margin-top:0; font-size: 1.3em">
        to customize the location and zoom level of your driftmap, just drag and zoom the map to the right, and click save.
      </h4>

    <% end %>
  </div>


  <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
    <div id="map"></div>

    <script type="text/javascript">
      var driftmap = {
        init_x: '<%= @post.init_x %>',
        init_y: '<%= @post.init_y %>',
        init_zoom: '<%= @post.init_zoom %>',
      }

      var blips = [];

      <% if @post.blips.any? %> 
        <% @post.blips.each do |blip| %>

          var blipImages = [];
          <% blip.blip_images.each do |blip_image| %>
            blipImages.push('<%= image_tag(blip_image.image).html_safe %>');
          <% end %>

          blips.push({
            id:   "<%= blip.id %>",
            x:    "<%= blip.x %>",
            y:    "<%= blip.y %>",
            title:  "<%= blip.title.to_json %>",
            body:   "<%= blip.body.to_json %>",
            images: blipImages
          })

        <% end %>
      <% end %>

      init_map('map', driftmap, blips)
    </script>
  </div>
</div>

<!-- Submit button -->
<div class="container">
  <div class="col-xs-12">
    <span class="normal save" style="margin: 5% 2%;">save</span>
  </div>
</div>

<script type="text/javascript">
  $(function(){
    $('span.normal.save').on('click', function(){
      var lat = window.map.getCenter().lat
      var lng = window.map.getCenter().lng
      var zoom = window.map.getZoom()

      $('#post_init_x').val(lat)
      $('#post_init_y').val(lng)
      $('#post_init_zoom').val(zoom)
      $('form').submit();
    });
  });
</script>