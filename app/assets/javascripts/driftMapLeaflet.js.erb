var DriftMapLeaflet = function(){
	// Private Variables
	var currentMarker
	var indexer = []

	L.Icon.Default.imagePath = '<%= (Rails.root + "/assets/leaflet").to_s %>';
	/* Custom Makers */
	var maroonMarker = L.icon({ 
	  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-maroon-icon.png").to_s %>',
	  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
	  popupAnchor:  [0, -35]
	});

	var blueMarker = L.icon({
	  iconUrl: '<%= (Rails.root + "/assets/leaflet/marker-icon.png").to_s %>',
	  shadowUrl: '<%= (Rails.root + "/assets/leaflet/marker-shadow.png").to_s %>',
	  popupAnchor:  [0, -35]
	});

	// Private Methods
	function focusWayPoint(){
		return true;
	}

	/* Event Listeners */

	return {
		// public variables


		// public methods
		init: function(routes, options){
			var x = options !== undefined ? options.init_x : 0.924206230200376;
			var y = options !== undefined ? options.init_y : -40.2400771379471;
			var z = options !== undefined ? options.init_zoom : 2;

			m = L.map('map').setView([x, y], z);
			// indexer['map'] = m;

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', 
				{	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		    	maxZoom: 18,
		    	id: 'eozelius77.j4hekake',
		    	accessToken: "<%= ENV['MAPBOX_SECRET_KEY'] %>"
				}).addTo(m);


			for(var x in routes){
				if(routes[x].route !== undefined && routes[x].waypoints !== undefined){
					var r = routes[x].route
					var wps = routes[x].waypoints

					for(var i in wps){
						/* Add Marker to Map */
						var lat = wps[i].x;
						var lng = wps[i].y;
						var id = wps[i].id;
						var title = wps[i].title;
						var body  = wps[i].body;

						/* Bind popup to marker */
						var popupContent = 	'<div class="blip-popup" data-blip="'+ id +'">' + 
																	'<div class="blip-text">' +
																		'<a href="/blips/'+ id +'">' +
																			'<h4 class="blip-popup-title instructions">'+ title +'</h4>' + 
																			'<span> - more</span>' +
																		'</a>' +
																		'<p class="blip-popup-body">'+ body +'</p>' + 
																	'</div>' +
																	'<img src="'+ wps[i].images[0].image.url +'" style="width: 100%; height:auto;">' +
																'</div>';

						var popupOptions = { className: 'blip-popup' }
						var wpMarker = L.marker([lat, lng]).addTo(m);
						var wpPopup  = L.popup(popupOptions).setLatLng([lat, lng]).setContent(popupContent);
						wpMarker.bindPopup(wpPopup);

						/* Add wayPoint to indexer */
						indexer.push({
							id: 		wps[i].id,
							title: 	title,
							body:  	body,
							marker: wpMarker,
							popup:  wpPopup
						});
					}					
				}
			}
			indexer[0].marker.setIcon(maroonMarker)
			indexer[0].popup.openOn(m)
		},

		/* Getters */
		getWayPoint: function(id){
			for(var i in indexer)
				if(indexer[i].id == id)
					return indexer[i];
			return false;
		},

		/* Setters */
		setWayPoint: function(id){
			var wp = DriftMapLeaflet.getWayPoint(id)

			if(wp){
				// reset all waypoint to blue
				for(var i in indexer)
					indexer[i].marker.setIcon(blueMarker)

				wp.marker.setIcon(maroonMarker)
				wp.popup.openOn(m)
			}			
		}
	}
}();