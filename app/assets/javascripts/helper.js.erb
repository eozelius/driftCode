function init_map(dom, driftmap, markers){
	try {
		var x = driftmap.init_x || 40.735;
		var y = driftmap.init_y || -73.890;
		var z = driftmap.init_zoom || 12;
		var m = window.map = L.map(dom).setView([x, y], z);

		// TODO make this API key a Server environment variable
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', 
			{	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    	maxZoom: 18,
	    	id: 'eozelius77.j4hekake',
	    	accessToken: 'pk.eyJ1IjoiZW96ZWxpdXM3NyIsImEiOiJkQmhDSl8wIn0.MzOmrtAL3uTNmVfLmEZ57g'
			}).addTo(m);
	
		// Add Markers to Map
		for(var i in markers){
			console.log('\nmarkers[i]: ' + markers[i])

			var markerOptions = {
				offset: [210, -30],
				className: 'marker-box'
			}

			var markerLat = xss_trim(markers[i].marker_x);
			var markerLng = xss_trim(markers[i].marker_y);
			var markerTitle = xss_trim(markers[i].marker_title);
			var markerBody = xss_trim(markers[i].marker_body);

			console.log("x: " + markerLat + '\ny: ' + markerLng + '\ntitle: ' + markerTitle + '\nbody: ' + markerBody);

			// todo xss protect
			var markerContent = '<div class="marker-content-wrapper">' + 
														'<p class="instructions">'+ markerTitle +'</p>' + 
														'<p>'+ markerBody +'</p>' + 
													'</div>';

			L.marker([markerLat, markerLng]).addTo(m);
			L.popup(markerOptions).setLatLng([markerLat, markerLng]).setContent(markerContent).openOn(m);

		}

	} catch(e) {
		console.log('error: ' + e);
		window.ethanerror = e;

		var imgSrc = "<%= asset_path('globe_0.jpg') %>"
		var errorMap = '<img class="error-map" src="'+ imgSrc +'">';
		$(dom).prepend(errorMap);
	}	
}

function flash_now(type, message){
	console.log("type: " + type + "\n message: " + message);

	var flash_msg = '<div style="margin:0; width:100%" class="flash-messages flash-'+ type +' col-lg-12 col-md-12 col-sm-12 col-xs-12"><p class="flash">'+ message +'</p></div>';
	$('.application-container').prepend(flash_msg).removeClass('hidden');
}

function xss_trim(str){
	return String(str)
	.replace(/&/g, '&amp;')
	.replace(/"/g, '&quot;')
	.replace(/'/g, '&#39;')
	.replace(/</g, '&lt;')
	.replace(/>/g, '&gt;')
	.replace('/', '&#x2F')
	.trim();
}
